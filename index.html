<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f6f7fb" />
  <title>PIA</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --accent:#2563eb; --accentSoft:#e8efff; --shadow:0 12px 28px rgba(16,24,40,.08);
      --r:18px; --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overscroll-behavior:none}
    header{position:sticky;top:0;z-index:10;background:rgba(246,247,251,.92);backdrop-filter:saturate(140%) blur(12px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .topRow{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.3px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .dateBox{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);min-width:240px;justify-content:space-between}
    .dateBox label{font-size:12px;color:var(--muted)}
    input[type="date"]{font:inherit;border:1px solid var(--line);background:#fbfcff;padding:10px 10px;border-radius:12px;color:var(--text);outline:none;width:155px}
    input[type="date"]:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--accentSoft)}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;margin-top:16px}
    .head{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--line);background:#f8fafc}
    .head .left{padding:16px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px}
    .head .right{padding:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px}
    .head .right small{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:.2px}
    .content{padding:12px}

    .group{border:1px solid var(--line);border-radius:16px;overflow:hidden;margin-bottom:12px;background:#fbfcff}
    .gTitle{padding:12px 14px;font-weight:900;font-size:14px;background:#eef5ff;border-bottom:1px solid var(--line)}
    .gTitle.orange{background:#fff2e6}
    .subs{display:grid;grid-template-columns:1fr;gap:10px;padding:12px}
    @media (min-width:680px){.subs{grid-template-columns:1fr 1fr}}

    .subCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background:#ffffff;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:box-shadow .12s ease,border-color .12s ease,transform .08s ease;
      position:relative;
    }
    .subCard:active{transform:translateY(1px)}
    .subCard.active{border-color:rgba(37,99,235,.55);box-shadow:0 10px 20px rgba(37,99,235,.12);background:var(--accentSoft)}
    .subTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .subName{font-weight:900;font-size:13px;line-height:1.1}
    .subMeta{margin-top:4px;font-size:12px;color:var(--muted);font-weight:700}
    .subRight{text-align:right}
    .subSum{font-weight:900;font-size:18px}
    .subAvg{margin-top:4px;font-size:12px;color:var(--muted);font-weight:800}

    .expr{
      margin-top:8px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:13px;
      color:#0f172a;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-height:18px;
    }
    .expr.muted{color:var(--muted)}

    .entryRow{display:none;margin-top:10px;gap:8px;align-items:center}
    .subCard.active .entryRow{display:flex}
    .numInput{
      flex:1;border:1px solid rgba(37,99,235,.35);background:#fbfcff;border-radius:12px;padding:12px 12px;
      font-size:16px;font-weight:900;outline:none
    }
    .numInput:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--accentSoft)}
    .okBtn{border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:900;border-radius:12px;padding:12px 14px;cursor:pointer;white-space:nowrap}
    .miniBtn{border:1px solid var(--line);background:#f1f5f9;color:var(--text);font-weight:900;border-radius:12px;padding:12px 12px;cursor:pointer;white-space:nowrap}

    .actions{
      display:flex;gap:10px;flex-wrap:wrap;padding:12px;border-top:1px solid var(--line);background:#f8fafc;
      justify-content:space-between;align-items:center
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:#f1f5f9;color:var(--text);border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .pill{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:12px;color:var(--muted);white-space:nowrap}
    .pill b{color:var(--text)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topRow">
      <div class="brand">
        <h1>PIA</h1>
        <div class="sub">Tryck på Flöde 1/2 → tangentbord direkt → OK</div>
      </div>
      <div class="dateBox">
        <div><label for="date">Datum</label></div>
        <input id="date" type="date" />
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="head">
      <div class="left">PIA</div>
      <div class="right">
        <small>Datum</small>
        <div id="dateTitle" style="font-weight:900">—</div>
      </div>
    </div>

    <div class="content" id="content"></div>

    <div class="actions">
      <div class="btnRow">
        <button class="btn primary" id="exportBtn">Exportera Excel</button>
        <button class="btn" id="undoBtn" title="Ångrar senaste för senast bokförda flöde">Ångra senaste</button>
        <button class="btn danger" id="clearDayBtn" title="Rensar endast valt datum">Rensa datum</button>
      </div>
      <div class="pill"><b id="grandTotal">0</b> totalt; <span id="countTotal">0</span> poster</div>
    </div>
  </section>
</main>

<script>
(() => {
  const GROUPS = [
    { title: "Efter formning – inför limning",        key: "G1", tint: "blue"   },
    { title: "Efter formning – inför bearbetning",    key: "G2", tint: "white"  },
    { title: "Efter bearbetning – inför limning",     key: "G3", tint: "orange" },
    { title: "Efter limning – inför fräsning",        key: "G4", tint: "blue"   },
    { title: "Efter fräsning – inför montering",      key: "G5", tint: "white"  },
    { title: "Efter fräsning – inför lastning",       key: "G6", tint: "blue"   },
  ];

  const SUBS = [
    { short: "Flöde 1", detail: "Limhjul" },
    { short: "Flöde 2", detail: "Byrå + H-lim" },
  ];

  const AREAS = [
    { groupKey:"G1", stage:"Efter formning, inför limning",        flow:"Flöde 1 Limhjul",       id:"01" },
    { groupKey:"G1", stage:"Efter formning, inför limning",        flow:"Flöde 2 Byrå+ H-lim",   id:"02" },
    { groupKey:"G2", stage:"Efter formning inför bearbetning",     flow:"Flöde 1 Limhjul",       id:"03" },
    { groupKey:"G2", stage:"Efter formning inför bearbetning",     flow:"Flöde 2 Byrå+ H-lim",   id:"04" },
    { groupKey:"G3", stage:"Efter bearbetning inför limning",      flow:"Flöde 1 Limhjul",       id:"05" },
    { groupKey:"G3", stage:"Efter bearbetning inför limning",      flow:"Flöde 2 Byrå+ H-lim",   id:"06" },
    { groupKey:"G4", stage:"Efter limning, inför fräsning",        flow:"Flöde 1 Limhjul",       id:"07" },
    { groupKey:"G4", stage:"Efter limning, inför fräsning",        flow:"Flöde 2 Byrå+ H-lim",   id:"08" },
    { groupKey:"G5", stage:"Efter fräsning inför montering",       flow:"Flöde 1 Limhjul",       id:"09" },
    { groupKey:"G5", stage:"Efter fräsning inför montering",       flow:"Flöde 2 Byrå+ H-lim",   id:"10" },
    { groupKey:"G6", stage:"Efter fräsning inför lastning",        flow:"Flöde 1 Limhjul",       id:"11" },
    { groupKey:"G6", stage:"Efter fräsning inför lastning",        flow:"Flöde 2 Byrå+ H-lim",   id:"12" },
  ];

  const STORE_KEY = "pia_groups_v3";
  const $ = (id) => document.getElementById(id);

  const elDate = $("date");
  const elDateTitle = $("dateTitle");
  const elContent = $("content");
  const elExport = $("exportBtn");
  const elUndo = $("undoBtn");
  const elClearDay = $("clearDayBtn");
  const elGrandTotal = $("grandTotal");
  const elCountTotal = $("countTotal");

  let store = { byDate:{} };

  // active while entering
  let activeAreaId = null;

  // remember last changed for Undo (even after auto-unselect)
  let lastAreaId = null;

  function pad(n){ return String(n).padStart(2,"0"); }
  function nowIsoDate(){
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function dayKey(){ return elDate.value || nowIsoDate(); }

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      store = raw ? JSON.parse(raw) : { byDate:{} };
      if (!store || typeof store !== "object") store = { byDate:{} };
      if (!store.byDate || typeof store.byDate !== "object") store.byDate = {};
    }catch{
      store = { byDate:{} };
    }
  }
  function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }

  function ensureDay(date){
    if (!store.byDate[date]) store.byDate[date] = {};
    return store.byDate[date];
  }
  function getNums(date, areaId){
    const day = ensureDay(date);
    if (!Array.isArray(day[areaId])) day[areaId] = [];
    return day[areaId];
  }

  function sanitizeValue(v){
    const s = String(v ?? "").trim();
    if (!/^\d{1,3}$/.test(s)) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function sum(nums){ return nums.reduce((a,b)=>a+b,0); }
  function exprText(nums){ return nums.length ? nums.join("+") : ""; }

  function computeDayTotals(date){
    let total = 0;
    let count = 0;
    for (const a of AREAS){
      const nums = getNums(date, a.id);
      total += sum(nums);
      count += nums.length;
    }
    return { total, count };
  }

  function avgPerCarrier(nums){
    if (!nums.length) return 0;
    return sum(nums) / nums.length;
  }

  // NEW: focus immediately in the same user gesture (no long press)
  function setActive(areaId){
    activeAreaId = areaId;

    // render creates input row now
    render();

    const input = document.querySelector(`input[data-input-for="${areaId}"]`);
    if (input){
      input.value = "";
      input.focus();
      input.click(); // extra push for iOS

      // fallback (some iOS versions)
      setTimeout(() => {
        try { input.focus(); input.click(); } catch {}
      }, 0);
    }
  }

  function addToArea(areaId, rawValue){
    const n = sanitizeValue(rawValue);
    if (n === null) return;

    const date = dayKey();
    const nums = getNums(date, areaId);
    nums.push(n);
    save();

    lastAreaId = areaId;

    // after OK: unselect everything
    activeAreaId = null;

    render();
  }

  function undoLast(){
    const target = lastAreaId;
    if (!target) return;

    const date = dayKey();
    const nums = getNums(date, target);
    if (nums.length === 0) return;

    nums.pop();
    save();
    render();
  }

  function clearDay(){
    const date = dayKey();
    const ok = confirm(`Rensa ALLT för ${date}?`);
    if (!ok) return;
    store.byDate[date] = {};
    save();
    activeAreaId = null;
    lastAreaId = null;
    render();
  }

  function render(){
    const date = dayKey();
    elDateTitle.textContent = date;

    const { total, count } = computeDayTotals(date);
    elGrandTotal.textContent = total;
    elCountTotal.textContent = count;

    elContent.innerHTML = GROUPS.map((g) => {
      const titleClass = g.tint === "orange" ? "orange" : "";
      const pair = AREAS.filter(x => x.groupKey === g.key);
      const p1 = pair[0], p2 = pair[1];

      const n1 = getNums(date, p1.id);
      const n2 = getNums(date, p2.id);

      const s1 = sum(n1), s2 = sum(n2);
      const e1 = exprText(n1), e2 = exprText(n2);

      const a1 = avgPerCarrier(n1);
      const a2 = avgPerCarrier(n2);

      const c1Active = activeAreaId === p1.id ? "active" : "";
      const c2Active = activeAreaId === p2.id ? "active" : "";

      const inputRow = (areaId) => `
        <div class="entryRow">
          <input class="numInput" data-input-for="${areaId}" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="0–999" />
          <button class="okBtn" data-ok="${areaId}">OK</button>
          <button class="miniBtn" data-cancel>✕</button>
        </div>
      `;

      return `
        <div class="group">
          <div class="gTitle ${titleClass}">${g.title}</div>
          <div class="subs">
            <div class="subCard ${c1Active}" data-area="${p1.id}">
              <div class="subTop">
                <div>
                  <div class="subName">${SUBS[0].short}</div>
                  <div class="subMeta">${SUBS[0].detail}</div>
                </div>
                <div class="subRight">
                  <div class="subSum">${s1}</div>
                  <div class="subAvg">Avg: ${a1.toFixed(1)}</div>
                </div>
              </div>
              <div class="expr ${e1? "" : "muted"}">${e1 || "—"}</div>
              ${c1Active ? inputRow(p1.id) : ""}
            </div>

            <div class="subCard ${c2Active}" data-area="${p2.id}">
              <div class="subTop">
                <div>
                  <div class="subName">${SUBS[1].short}</div>
                  <div class="subMeta">${SUBS[1].detail}</div>
                </div>
                <div class="subRight">
                  <div class="subSum">${s2}</div>
                  <div class="subAvg">Avg: ${a2.toFixed(1)}</div>
                </div>
              </div>
              <div class="expr ${e2? "" : "muted"}">${e2 || "—"}</div>
              ${c2Active ? inputRow(p2.id) : ""}
            </div>
          </div>
        </div>
      `;
    }).join("");

    // Use pointerup for iOS responsiveness
    elContent.querySelectorAll("[data-area]").forEach(card => {
      card.addEventListener("pointerup", (e) => {
        const t = e.target;
        if (t && (t.matches("[data-ok]") || t.matches("[data-cancel]") || t.closest("[data-ok]"))) return;
        setActive(card.getAttribute("data-area"));
      }, { passive:false });
    });

    elContent.querySelectorAll("[data-ok]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const areaId = btn.getAttribute("data-ok");
        const input = document.querySelector(`input[data-input-for="${areaId}"]`);
        if (!input) return;
        addToArea(areaId, input.value);
      });
    });

    elContent.querySelectorAll("[data-cancel]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        activeAreaId = null;
        render();
      });
    });

    elContent.querySelectorAll("input[data-input-for]").forEach(input => {
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          e.preventDefault();
          const areaId = input.getAttribute("data-input-for");
          addToArea(areaId, input.value);
        } else if (e.key === "Escape"){
          e.preventDefault();
          activeAreaId = null;
          render();
        }
      });
    });
  }

  function toCsvSemicolon(rows){
    const esc = (s) => {
      const str = String(s ?? "");
      if (/[;"\n\r]/.test(str)) return `"${str.replaceAll('"','""')}"`;
      return str;
    };
    return rows.map(r => r.map(esc).join(";")).join("\r\n");
  }

  function exportCsv(){
    const header = ["Datum","Område","Flöde","Värde"];
    const rows = [];
    const dates = Object.keys(store.byDate).sort();
    for (const date of dates){
      for (const a of AREAS){
        const nums = getNums(date, a.id);
        for (const n of nums){
          rows.push([date, a.stage, a.flow, n]);
        }
      }
    }
    const csv = toCsvSemicolon([header, ...rows]);
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
    link.href = url;
    link.download = `PIA_${stamp}.csv`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }

  window.addEventListener("beforeunload", (e) => {
    e.preventDefault();
    e.returnValue = "";
    return "";
  });

  function init(){
    load();
    elDate.value = nowIsoDate();
    activeAreaId = null;
    lastAreaId = null;
    render();

    elDate.addEventListener("change", () => {
      activeAreaId = null;
      lastAreaId = null;
      render();
    });

    elExport.addEventListener("click", exportCsv);
    elUndo.addEventListener("click", undoLast);
    elClearDay.addEventListener("click", clearDay);
  }

  init();
})();
</script>
</body>
</html>
