<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Klocktr√§ning ‚Äì Analog & Digital</title>
<style>
  :root{
    --bg:#f7fafc;           /* ljus bakgrund */
    --card:#ffffff;         /* kortbakgrund */
    --ink:#1f2937;          /* text */
    --primary:#3b82f6;      /* bl√• */
    --ok:#10b981;           /* gr√∂n */
    --warn:#f59e0b;         /* orange */
    --err:#ef4444;          /* r√∂d */
    --muted:#6b7280;
    --shadow:0 10px 30px rgba(0,0,0,.07);
    --radius:18px;
  }
  html,body{height:100%;}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    background:var(--bg); color:var(--ink);
    display:flex; align-items:center; justify-content:center;
  }
  .app{ width:min(920px, 100%); padding:16px; }
  .grid{
    display:grid; gap:16px;
    grid-template-columns: 1fr; 
  }
  @media (min-width: 880px){
    .grid{ grid-template-columns: 360px 1fr; }
  }
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px;
  }
  h1{font-size:1.4rem; margin:4px 0 12px}
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .chip{
    border:1px solid #e5e7eb; padding:10px 14px; border-radius:999px; cursor:pointer; user-select:none;
    background:#fff;
  }
  .chip input{ display:none; }
  .chip.active{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.15);}
  .toggle{ display:flex; align-items:center; gap:10px; }
  .toggle input{ width:48px; height:28px; appearance:none; background:#e5e7eb; border-radius:999px; position:relative; outline:none; cursor:pointer;}
  .toggle input:checked{ background:var(--primary); }
  .toggle input:before{
    content:""; position:absolute; width:22px; height:22px; border-radius:50%; background:#fff; top:3px; left:3px; transition:.2s;
    box-shadow: 0 2px 6px rgba(0,0,0,.15);
  }
  .toggle input:checked:before{ left:23px; }
  .clock-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  canvas{ width:min(300px, 85vw); height:min(300px, 85vw); touch-action:none; }
  .kbd{
    padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-size:1.1rem; width:140px;
  }
  .btn{
    padding:14px 18px; border:none; border-radius:12px; font-weight:600; cursor:pointer; 
    background:var(--primary); color:#fff; box-shadow:var(--shadow); font-size:1rem;
  }
  .btn.secondary{ background:#e5e7eb; color:#111827; }
  .btn.ghost{ background:#fff; border:1px solid #e5e7eb; color:#111827;}
  .btn:active{ transform: translateY(1px); }
  .stat{
    display:flex; gap:12px; flex-wrap:wrap; margin-top:6px;
  }
  .pill{
    background:#f3f4f6; border-radius:999px; padding:8px 12px; font-size:.95rem;
  }
  .msg{ font-weight:700; margin:6px 0 0; }
  .msg.ok{ color:var(--ok); }
  .msg.err{ color:var(--err); }
  .muted{ color:var(--muted); font-size:.92rem; }
  .section-title{ font-weight:700; margin:6px 0 8px; }
  .grow{ flex:1; }
  .spacer{ height:8px; }
</style>
</head>
<body>
  <div class="app">
    <div class="grid">
      <!-- Kontroller -->
      <div class="card">
        <h1>‚è∞ Klocktr√§ning</h1>

        <div class="section">
          <div class="section-title">L√§ge</div>
          <div id="modeRow" class="row"></div>
          <div class="muted">‚Ä¢ <b>Skriv tiden</b>: L√§s av analog klocka och skriv 24-timmars tid (HH:MM).<br>
            ‚Ä¢ <b>St√§ll visarna</b>: F√• en digital tid (24h) och st√§ll analog 12h korrekt.<br>
            ‚Ä¢ <b>Mix</b>: Blandat.</div>
        </div>

        <div class="spacer"></div>

        <div class="section">
          <div class="section-title">Niv√•</div>
          <div id="levelRow" class="row"></div>
          <div class="muted">L√§tt: :00 och :30 ‚Ä¢ Medel: 5-min ‚Ä¢ Sv√•r: minutprecision</div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <label class="toggle">
            <input id="compToggle" type="checkbox">
            <span>T√§vlingsl√§ge (r√§tt i rad)</span>
          </label>
          <button id="newBtn" class="btn ghost">Ny uppgift</button>
          <button id="checkBtn" class="btn">Kolla svar</button>
        </div>

        <div class="stat">
          <div class="pill">R√§tt i rad: <span id="streak">0</span></div>
          <div class="pill">B√§sta streak: <span id="best">0</span></div>
          <div class="pill">Totalt r√§tt: <span id="correct">0</span></div>
        </div>
        <div id="feedback" class="msg muted">Redo!</div>
      </div>

      <!-- √ñvningsyta -->
      <div class="card">
        <div class="clock-wrap">
          <canvas id="clock" width="500" height="500" aria-label="Analog klocka"></canvas>

          <div id="digitalBox" class="row" style="display:none;">
            <div class="muted">Digital tid (24h):</div>
            <div id="digitalLabel" style="font-size:1.6rem; font-weight:800;">14:25</div>
            <div class="grow"></div>
            <button id="centerBtn" class="btn secondary">Centrera visare</button>
          </div>

          <div id="inputBox" class="row" style="display:none;">
            <label for="timeInput" class="muted">Skriv 24h-tid (HH:MM):</label>
            <input id="timeInput" class="kbd" inputmode="numeric" placeholder="HH:MM" autocomplete="off" />
            <button id="clearBtn" class="btn secondary">Rensa</button>
          </div>

          <div class="muted">Tips: Nyp och dra i minut- eller timvisaren f√∂r att st√§lla tiden.</div>
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:10px; text-align:center;">
      Byggd f√∂r iPhone & GitHub Pages ‚Ä¢ Sparar b√§sta streak i din webbl√§sare
    </div>
  </div>

<script>
/* ======= Tillst√•nd ======= */
const modes = [
  {key:'skriv', label:'Skriv tiden'},
  {key:'stall', label:'St√§ll visarna'},
  {key:'mix',   label:'Mix'}
];
const levels = [
  {key:'latt',  label:'L√§tt (:00, :30)', step:30},
  {key:'medel', label:'Medel (5-min)',   step:5},
  {key:'svar',  label:'Sv√•r (1-min)',    step:1},
];

let state = {
  mode: 'skriv',
  level: 'latt',
  step: 30,                 // min-steg
  comp: false,              // t√§vlingsl√§ge
  streak: 0,
  best: Number(localStorage.getItem('klock_best_streak')||0),
  correctTotal: 0,

  // aktuell uppgift (m√•l)
  targetH24: 14,
  targetM: 30,

  // anv√§ndarens analog-inst√§llning (12h)
  userH12: 3,
  userM: 0,

  // interaktion
  dragging: null, // 'min' | 'hour' | null
};

/* ======= UI-element ======= */
const modeRow = document.getElementById('modeRow');
const levelRow = document.getElementById('levelRow');
const compToggle = document.getElementById('compToggle');
const newBtn = document.getElementById('newBtn');
const checkBtn = document.getElementById('checkBtn');
const streakEl = document.getElementById('streak');
const bestEl = document.getElementById('best');
const correctEl = document.getElementById('correct');
const feedback = document.getElementById('feedback');

const clock = document.getElementById('clock');
const ctx = clock.getContext('2d');
const digitalBox = document.getElementById('digitalBox');
const digitalLabel = document.getElementById('digitalLabel');
const centerBtn = document.getElementById('centerBtn');

const inputBox = document.getElementById('inputBox');
const timeInput = document.getElementById('timeInput');
const clearBtn = document.getElementById('clearBtn');

/* ======= Bygg chips ======= */
function renderChips(){
  modeRow.innerHTML = '';
  modes.forEach(m=>{
    const div = document.createElement('div');
    div.className='chip'+(state.mode===m.key?' active':'');
    div.textContent = m.label;
    div.onclick=()=>{
      state.mode=m.key;
      renderChips();
      layoutForMode();
      newTask();
    };
    modeRow.appendChild(div);
  });

  levelRow.innerHTML = '';
  levels.forEach(l=>{
    const div = document.createElement('div');
    div.className='chip'+(state.level===l.key?' active':'');
    div.textContent = l.label;
    div.onclick=()=>{
      state.level=l.key;
      state.step = l.step;
      renderChips();
      newTask();
    };
    levelRow.appendChild(div);
  });
}
renderChips();

/* ======= Layout per l√§ge ======= */
function layoutForMode(){
  if(state.mode==='skriv'){
    // visa analog klocka ‚Üí skriv digital tid
    inputBox.style.display = 'flex';
    digitalBox.style.display = 'none';
    timeInput.value='';
    feedback.className='msg muted';
    feedback.textContent='L√§s av klockan och skriv tiden (24h, HH:MM).';
  } else if(state.mode==='stall'){
    // visa digital tid ‚Üí st√§ll visarna
    inputBox.style.display = 'none';
    digitalBox.style.display = 'flex';
    feedback.className='msg muted';
    feedback.textContent='Dra i visarna s√• att de matchar den digitala tiden.';
  } else {
    // mix: slumpa vilket delmoment
    // (styrs i newTask)
  }
}

/* ======= Slumpa uppgift ======= */
function randInt(a,b){ return a + Math.floor(Math.random()*(b-a+1)); }

function generateTime(step){
  const minutesPool = [];
  if(step===30){ [0,30].forEach(m=>minutesPool.push(m)); }
  else if(step===5){ for(let m=0;m<60;m+=5) minutesPool.push(m); }
  else { for(let m=0;m<60;m++) minutesPool.push(m); }
  const m = minutesPool[randInt(0, minutesPool.length-1)];
  const h24 = randInt(0,23);
  return {h24, m};
}

function newTask(){
  // om mix: 50/50 mellan skriv/st√§ll
  let mode = state.mode;
  if(mode==='mix'){
    mode = (Math.random()<0.5)?'skriv':'stall';
  }

  ({h24: state.targetH24, m: state.targetM} = generateTime(state.step));

  // startl√§ge f√∂r anv√§ndarens visare: centrera p√• 12:00
  state.userH12 = 12;
  state.userM = 0;

  // uppdatera UI
  if(mode==='skriv'){
    inputBox.style.display = 'flex';
    digitalBox.style.display = 'none';
    timeInput.value='';
    feedback.className='msg muted';
    feedback.textContent='L√§s av klockan och skriv tiden (24h, HH:MM).';
  } else {
    inputBox.style.display = 'none';
    digitalBox.style.display = 'flex';
    digitalLabel.textContent = toHHMM(state.targetH24, state.targetM);
    feedback.className='msg muted';
    feedback.textContent='St√§ll visarna till den digitala tiden.';
  }

  draw();
}

/* ======= Format & j√§mf√∂relse ======= */
function toHHMM(h24, m){
  const h = String(h24).padStart(2,'0');
  const mm = String(m).padStart(2,'0');
  return `${h}:${mm}`;
}
function clampMinuteToStep(minute, step){
  if(step===1) return minute;
  const snap = Math.round(minute/step)*step;
  return (snap+60)%60;
}
function hour24eq12(h24, h12){
  // matcha 24h mot 12h (12 == 0 mod 12)
  const a = h24 % 12;
  const b = h12 % 12;
  return a===b;
}

/* ======= Rita klockan ======= */
function draw(){
  const w = clock.width, h = clock.height;
  const cx = w/2, cy = h/2;
  const R = Math.min(w,h)*0.45;

  ctx.clearRect(0,0,w,h);

  // urtavla
  ctx.beginPath();
  ctx.arc(cx,cy,R,0,Math.PI*2);
  ctx.fillStyle="#fff";
  ctx.fill();
  ctx.lineWidth = 6;
  ctx.strokeStyle = "#e5e7eb";
  ctx.stroke();

  // markeringar (tim & 5-min)
  for(let i=0;i<60;i++){
    const ang = (Math.PI*2)*i/60 - Math.PI/2;
    const r1 = R-8;
    const r2 = (i%5===0)? R-22 : R-14;
    ctx.beginPath();
    ctx.moveTo(cx + r1*Math.cos(ang), cy + r1*Math.sin(ang));
    ctx.lineTo(cx + r2*Math.cos(ang), cy + r2*Math.sin(ang));
    ctx.lineWidth = (i%5===0)? 4 : 2;
    ctx.strokeStyle = (i%5===0)? "#94a3b8" : "#cbd5e1";
    ctx.stroke();
  }

  // siffror
  ctx.fillStyle = "#111827";
  ctx.font = `${R*0.16}px Inter, ui-sans-serif, system-ui`;
  ctx.textAlign="center"; ctx.textBaseline="middle";
  for(let hr=1; hr<=12; hr++){
    const ang = (Math.PI*2)*hr/12 - Math.PI/2;
    const rr = R-40;
    ctx.fillText(String(hr), cx + rr*Math.cos(ang), cy + rr*Math.sin(ang));
  }

  // best√§m visare att rita:
  let showH12, showM;
  if(state.mode==='skriv'){
    // visa m√•l (analog ‚Üí skriv digital)
    const h12 = ((state.targetH24 % 12) || 12);
    showH12 = h12; showM = state.targetM;
  } else if (state.mode==='stall'){
    // visa anv√§ndarens visare
    showH12 = state.userH12; showM = state.userM;
  } else {
    // i mix styrs av vilken deluppgift vi startade
    // best√§m via vilka boxar som syns
    if (inputBox.style.display==='flex'){
      const h12 = ((state.targetH24 % 12) || 12);
      showH12 = h12; showM = state.targetM;
    } else {
      showH12 = state.userH12; showM = state.userM;
    }
  }

  // ber√§kna vinklar
  const minuteAngle = Math.PI*2*(showM/60) - Math.PI/2;
  // timvisare tar h√§nsyn till minuter
  const hourAngle = Math.PI*2*((showH12%12)/12 + showM/60/12) - Math.PI/2;

  // timvisare
  drawHand(cx,cy, hourAngle, R*0.5, 8, "#111827");
  // minutvisare
  drawHand(cx,cy, minuteAngle, R*0.72, 6, "#111827");

  // centrumknapp
  ctx.beginPath();
  ctx.arc(cx,cy,8,0,Math.PI*2);
  ctx.fillStyle="#111827";
  ctx.fill();
}
function drawHand(cx,cy, angle, length, width, color){
  const x = cx + length*Math.cos(angle);
  const y = cy + length*Math.sin(angle);
  ctx.beginPath();
  ctx.lineCap = "round";
  ctx.moveTo(cx,cy);
  ctx.lineTo(x,y);
  ctx.lineWidth = width;
  ctx.strokeStyle = color;
  ctx.stroke();
}

/* ======= Pekinteraktion f√∂r visare ======= */
function getPointerPos(evt){
  const rect = clock.getBoundingClientRect();
  const isTouch = evt.touches && evt.touches.length;
  const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
  const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
  const x = (clientX - rect.left) * (clock.width/rect.width);
  const y = (clientY - rect.top) * (clock.height/rect.height);
  return {x,y};
}
function angleFromCenter(x,y){
  const cx = clock.width/2, cy = clock.height/2;
  return Math.atan2(y-cy, x-cx); // -PI..PI, 0 = +x (h√∂ger)
}
function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }

function whichHandNear(pos){
  // avg√∂r vilken hand man tog tag i, baserat p√• n√§rmast spets
  const cx = clock.width/2, cy = clock.height/2;
  // nuvarande handpositioner (vi anv√§nder userH12/userM n√§r vi st√§ller visare)
  const m = state.userM;
  const h12 = state.userH12;
  const R = Math.min(clock.width, clock.height)*0.45;

  const minuteAngle = Math.PI*2*(m/60) - Math.PI/2;
  const hourAngle = Math.PI*2*((h12%12)/12 + m/60/12) - Math.PI/2;

  const minPt = {x: cx + (R*0.72)*Math.cos(minuteAngle), y: cy + (R*0.72)*Math.sin(minuteAngle)};
  const hourPt= {x: cx + (R*0.5)*Math.cos(hourAngle),   y: cy + (R*0.5)*Math.sin(hourAngle)};

  const dm = dist(pos.x,pos.y, minPt.x,minPt.y);
  const dh = dist(pos.x,pos.y, hourPt.x,hourPt.y);
  return (dm<dh) ? 'min' : 'hour';
}

function onPointerDown(evt){
  // bara relevant n√§r vi st√§ller visarna
  const activeIsSetHands = (state.mode==='stall') || (state.mode==='mix' && digitalBox.style.display==='flex');
  if(!activeIsSetHands) return;

  const pos = getPointerPos(evt);
  state.dragging = whichHandNear(pos);
  onPointerMove(evt); // direkt uppdatering
}
function onPointerMove(evt){
  if(!state.dragging) return;
  evt.preventDefault();

  const pos = getPointerPos(evt);
  const ang = angleFromCenter(pos.x, pos.y); // -PI..PI, 0=+x
  // konvertera till minuter/timmar
  let deg = (ang + Math.PI/2) * 180/Math.PI; // 0 uppe, medurs
  if(deg<0) deg += 360;

  if(state.dragging==='min'){
    let minute = Math.round(deg/6); // 360/60 = 6¬∞/min
    minute = minute % 60;
    minute = clampMinuteToStep(minute, state.step);
    state.userM = minute;
  } else {
    // timme per 30¬∞, 12 steg
    let rawHour = Math.round(deg/30); // 0..12
    rawHour = rawHour % 12;
    state.userH12 = (rawHour===0)?12:rawHour;
  }
  draw();
}
function onPointerUp(){ state.dragging=null; }

clock.addEventListener('mousedown', onPointerDown);
clock.addEventListener('mousemove', onPointerMove);
window.addEventListener('mouseup', onPointerUp);

clock.addEventListener('touchstart', onPointerDown, {passive:false});
clock.addEventListener('touchmove', onPointerMove, {passive:false});
clock.addEventListener('touchend', onPointerUp);

/* ======= Kontrollknappar ======= */
compToggle.onchange = ()=>{
  state.comp = compToggle.checked;
  feedback.className='msg muted';
  feedback.textContent = state.comp ? 'T√§vlingsl√§ge p√• ‚Äì hur l√•ng streak klarar du?' : 'T√§vlingsl√§ge av.';
  if(state.comp){
    state.streak = 0;
    updateStats();
  }
  newTask();
};
newBtn.onclick = ()=>{ newTask(); };
checkBtn.onclick = ()=> checkAnswer();
centerBtn.onclick = ()=>{
  // centrera (12:00) f√∂r att b√∂rja om n√§r man st√§ller visarna
  state.userH12 = 12; state.userM = 0; draw();
};
clearBtn.onclick = ()=>{ timeInput.value=''; timeInput.focus(); };

/* ======= Svarslogik ======= */
function checkAnswer(){
  const activeMode = (state.mode==='mix')
    ? (inputBox.style.display==='flex' ? 'skriv' : 'stall')
    : state.mode;

  let ok = false;
  if(activeMode==='skriv'){
    // anv√§ndaren skriver 24h (HH:MM) f√∂r analog m√•l
    const raw = (timeInput.value||'').trim();
    const match = raw.match(/^(\d{1,2})\s*[:.]\s*(\d{2})$/);
    if(!match){ showErr('Skriv tiden som HH:MM, t.ex. 07:30'); return; }
    let hh = Number(match[1]), mm = Number(match[2]);
    if(!(hh>=0 && hh<=23 && mm>=0 && mm<=59)){ showErr('Ogiltig tid. Anv√§nd 00‚Äì23 f√∂r timmar.'); return; }

    // j√§mf√∂r mot target (med niv√•begr√§nsning)
    const step = state.step;
    const mmSnap = (step===1)?mm: clampMinuteToStep(mm, step);
    if(mm !== mmSnap){ showErr(`P√• denna niv√• anv√§nds ${step===30?':00 eller :30': step===5?'5-min':'minutprecision'}.`); return; }

    ok = (hh===state.targetH24 && mm===state.targetM);
  } else {
    // st√§ller visare (12h) f√∂r given 24h digital
    const sameHour = hour24eq12(state.targetH24, state.userH12);
    const sameMin = state.userM===state.targetM;
    ok = (sameHour && sameMin);
  }

  if(ok){
    showOk('R√§tt! üéâ');
    state.correctTotal++;
    if(state.comp){
      state.streak++;
      if(state.streak>state.best){
        state.best = state.streak;
        localStorage.setItem('klock_best_streak', String(state.best));
      }
    }
    updateStats();
    // ny uppgift direkt i t√§vlingsl√§ge, annars l√•t eleven trycka Ny uppgift
    if(state.comp){ setTimeout(newTask, 600); }
  }else{
    showErr('Inte riktigt. F√∂rs√∂k igen!');
    if(state.comp){
      state.streak = 0;
      updateStats();
    }
  }
}
function updateStats(){
  streakEl.textContent = state.streak;
  bestEl.textContent = state.best;
  correctEl.textContent = state.correctTotal;
}
function showOk(t){
  feedback.className = 'msg ok';
  feedback.textContent = t;
}
function showErr(t){
  feedback.className = 'msg err';
  feedback.textContent = t;
}

/* ======= Init ======= */
function firstLayout(){
  bestEl.textContent = state.best;
  compToggle.checked = state.comp;
  layoutForMode();
  newTask();
}
firstLayout();

</script>
</body>
</html>
